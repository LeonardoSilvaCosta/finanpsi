"use strict";(()=>{var e={};e.id=52,e.ids=[52,291],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4688:(e,o,s)=>{s.r(o),s.d(o,{patchFetch:()=>x,routeModule:()=>p,serverHooks:()=>f,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>g});var r={};s.r(r),s.d(r,{POST:()=>u});var a=s(2412),i=s(4293),t=s(4147),n=s(7856),c=s(7888),l=s(6291),d=s(7657);async function u(e){let o=(0,d.Ge)(e,{maxRequests:Number(process.env.INSTANT_DIAGNOSIS_RATE_LIMIT||10),windowMs:Number(process.env.RATE_LIMIT_WINDOW_MS||9e5)});if(o&&!o.allowed)return console.warn("[Instant Diagnosis Rate Limit] Requisi\xe7\xe3o bloqueada:",o),n.NextResponse.json({error:"Muitas requisi\xe7\xf5es. Tente novamente mais tarde.",retryAfter:Math.ceil((o.resetTime-Date.now())/1e3)},{status:429,headers:{"Retry-After":String(Math.ceil((o.resetTime-Date.now())/1e3)),"X-RateLimit-Limit":String(process.env.INSTANT_DIAGNOSIS_RATE_LIMIT||10),"X-RateLimit-Remaining":String(o.remaining),"X-RateLimit-Reset":String(o.resetTime)}});try{let{challenge:o,profession:r,name:a,type:i="basic"}=await e.json();if(!o||o.trim().length<10)return n.NextResponse.json({error:"Desafio \xe9 obrigat\xf3rio e deve ter pelo menos 10 caracteres"},{status:400});let t={name:a||"Usu\xe1rio",email:"",profession:r||"",challenge:o,groupAccepted:!1},d=(0,c.zr)(o);if("basic"===i){let e=(0,c.Cb)(t),o={preview:!0,category:d.category,confidence:d.confidence,summary:e,keywords:d.keywords,message:`Identificamos que seu principal desafio est\xe1 relacionado a **${d.category}**. ${e}`,nextSteps:["Complete seu cadastro para receber o diagn\xf3stico completo e personalizado","Participe da comunidade FinanPsi para suporte cont\xednuo","Receba dicas pr\xe1ticas e acion\xe1veis por e-mail"]};return n.NextResponse.json({success:!0,diagnosis:o,method:"rules",timestamp:new Date().toISOString()})}if("full"===i){let e="",o="rules";if(process.env.FLOWISE_BASE_URL)try{let s=await (0,l.generateDiagnosisWithFlowise)(t);s.success&&s.diagnosis&&(e=s.diagnosis,o="flowise",console.log("[Instant Diagnosis] Diagn\xf3stico gerado com Flowise"))}catch(e){console.error("[Instant Diagnosis] Erro ao usar Flowise:",e)}if(!e){let{generateDiagnosis:r}=await Promise.resolve().then(s.bind(s,7888));e=r(t),o="rules",console.log("[Instant Diagnosis] Diagn\xf3stico gerado com regras")}return n.NextResponse.json({success:!0,diagnosis:{preview:!1,category:d.category,confidence:d.confidence,fullText:e,keywords:d.keywords},method:o,timestamp:new Date().toISOString()})}return n.NextResponse.json({error:"Tipo de diagn\xf3stico inv\xe1lido. Use 'basic' ou 'full'."},{status:400})}catch(e){return console.error("[Instant Diagnosis] Erro:",e),n.NextResponse.json({error:"Erro ao gerar diagn\xf3stico instant\xe2neo",message:e.message||"Erro desconhecido"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/instant-diagnosis/route",pathname:"/api/instant-diagnosis",filename:"route",bundlePath:"app/api/instant-diagnosis/route"},resolvedPagePath:"/Users/leonardocosta/Documents/projetos pessoais/FinanPsi/apps/web/app/api/instant-diagnosis/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:m,workUnitAsyncStorage:g,serverHooks:f}=p;function x(){return(0,t.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:g})}},6291:(e,o,s)=>{async function r(e){let o=Date.now(),s=function(){let e=process.env.FLOWISE_BASE_URL||process.env.NEXT_PUBLIC_FLOWISE_URL;return e?{baseUrl:e.replace(/\/$/,""),apiKey:process.env.FLOWISE_API_KEY,timeout:Number(process.env.FLOWISE_TIMEOUT||3e4)}:(console.warn("[Flowise] FLOWISE_BASE_URL n\xe3o configurado"),null)}();if(!s)return{success:!1,error:"Flowise n\xe3o configurado",method:"fallback",responseTime:Date.now()-o};let r=process.env.FLOWISE_CHATFLOW_ID||"default",a=`${s.baseUrl}/api/v1/prediction/${r}`,i=function(e){let o=e.profession||"profissional",s=e.challenge||"desafios financeiros gerais",r=e.groupAccepted?"O lead demonstrou interesse em participar de grupo de apoio.":"O lead n\xe3o demonstrou interesse em grupo de apoio no momento.";return`Voc\xea \xe9 um consultor financeiro especializado em ajudar psic\xf3logos e profissionais da sa\xfade que s\xe3o aut\xf4nomos e enfrentam desafios financeiros.

Contexto do Lead:
- Nome: ${e.name}
- Profiss\xe3o: ${o}
- Maior desafio financeiro: ${s}
- Interesse em grupo: ${r}

Gere um diagn\xf3stico financeiro personalizado, profissional e acolhedor que:
1. Identifique o principal desafio mencionado
2. Forne\xe7a an\xe1lises e a\xe7\xf5es pr\xe1ticas e espec\xedficas
3. Considere a realidade de profissionais aut\xf4nomos da \xe1rea de sa\xfade
4. Mantenha um tom emp\xe1tico e encorajador
5. Inclua passos de a\xe7\xe3o concretos e realiz\xe1veis
6. Seja relevante para a situa\xe7\xe3o espec\xedfica do lead

Formato desejado:
- Sauda\xe7\xe3o personalizada
- Identifica\xe7\xe3o da situa\xe7\xe3o/diagn\xf3stico
- A\xe7\xf5es recomendadas (bullet points)
- Insights espec\xedficos para profissionais da sa\xfade (se aplic\xe1vel)
- Mensagem sobre comunidade (se aplic\xe1vel)
- Assinatura da Equipe FinanPsi

Mantenha o diagn\xf3stico focado, pr\xe1tico e acolhedor. Evite jarg\xf5es t\xe9cnicos complexos demais.`}(e);try{let r=new AbortController,t=setTimeout(()=>r.abort(),s.timeout),n={"Content-Type":"application/json"};s.apiKey&&(n.Authorization=`Bearer ${s.apiKey}`),console.log(`[Flowise] Enviando requisi\xe7\xe3o para: ${a}`),console.log(`[Flowise] Lead: ${e.email}`);let c=await fetch(a,{method:"POST",headers:n,body:JSON.stringify({question:i,inputs:{leadName:e.name,leadEmail:e.email,leadProfession:e.profession||"",leadChallenge:e.challenge||"",leadGroupAccepted:e.groupAccepted}}),signal:r.signal});if(clearTimeout(t),!c.ok){let e=`Flowise retornou erro ${c.status}`,s="";try{let o=await c.text();console.error(`[Flowise] Erro HTTP ${c.status}:`,o);try{let r=JSON.parse(o);r.message?(s=r.message).includes("model")&&s.includes("does not exist")?(e="Modelo LLM n\xe3o configurado no chatflow do Flowise",console.error("[Flowise] ⚠️  ATEN\xc7\xc3O: O chatflow precisa ter um modelo LLM configurado. Acesse o Flowise e configure um n\xf3 LLM no seu chatflow.")):r.error?.message&&(s=r.error.message):r.error&&(s=JSON.stringify(r.error))}catch{s=o.substring(0,200)}s&&(e=`${e}: ${s}`)}catch(e){console.error("[Flowise] Erro ao ler resposta de erro:",e)}return{success:!1,error:e,method:"fallback",responseTime:Date.now()-o}}let l=await c.json(),d=Date.now()-o,u="";if(l.text?u=l.text:l.answer?u=l.answer:l.response?u=l.response:"string"==typeof l?u=l:(u=JSON.stringify(l,null,2),console.warn("[Flowise] Formato de resposta n\xe3o reconhecido, usando JSON completo")),!u||0===u.trim().length)throw Error("Resposta vazia do Flowise");return console.log(`[Flowise] Diagn\xf3stico gerado com sucesso em ${d}ms`),{success:!0,diagnosis:u.trim(),method:"flowise",responseTime:d}}catch(i){let e=Date.now()-o,r=i.message||String(i),a="AbortError"===i.name||r.includes("aborted");return a?console.error(`[Flowise] Timeout ap\xf3s ${s.timeout}ms`):console.error("[Flowise] Erro ao gerar diagn\xf3stico:",r),{success:!1,error:a?"Timeout ao conectar com Flowise":r,method:"fallback",responseTime:e}}}s.d(o,{generateDiagnosisWithFlowise:()=>r})}};var o=require("../../../webpack-runtime.js");o.C(e);var s=e=>o(o.s=e),r=o.X(0,[267,814,781],()=>s(4688));module.exports=r})();